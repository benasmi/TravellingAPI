<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.travel.travelapi.services.TourDayService">


    <select id="getLocalPlacesByTourId"  resultType="com.travel.travelapi.models.TourLocalPlaceInfo">
        SELECT * FROM TOUR_DAY td INNER JOIN
            PLACE_TOUR_DAY ptd ON td.tourDayId = ptd.fk_tourDayId
    </select>

    <select id="getApiPlacesByTourId"  resultType="com.travel.travelapi.models.TourApiPlaceInfo">
        SELECT * FROM TOUR_DAY td INNER JOIN
                      API_PLACE_TOUR apt ON td.tourDayId = apt.fk_tourDayId
    </select>

    <select id="getTourDaysDetails"  resultType="com.travel.travelapi.models.TourDayDetails">
        SELECT description FROM TOUR_DAY WHERE fk_tourId=#{id}
    </select>

    <delete id="deleteTourDaysById">
        DELETE FROM TOUR_DAY WHERE fk_tourId=#{id}
    </delete>

    <insert id="insertTourDaysById">
        <foreach item="day" collection="tour.days" index="i">
            INSERT INTO TOUR_DAY (day, fk_tourId, description) VALUES (#{i}, #{id}, #{day.description});
            SET @tourDayId = (SELECT LAST_INSERT_ID());
            <foreach item="p" collection="day.data" index="pos">
                <if test="p.place.type == 0">
                    INSERT INTO PLACE_TOUR_DAY (fk_tourDayId, fk_placeId, position) VALUES (@tourDayId, #{p.place.placeId}, #{pos});
                    SET @placeInsertedId = (SELECT LAST_INSERT_ID());
                    <foreach item="t" collection="p.transport">
                        INSERT INTO TRANSPORT_PLACE_TOUR (fk_placeTourId,fk_transportId) VALUES (@placeInsertedId, #{t.fk_transportId});
                    </foreach>
                </if>
                <if test="p.place.type == 1">
                    INSERT INTO API_PLACE (apiPlaceId, fk_typeId) VALUES (#{p.place.placeId}, 1)
                    ON DUPLICATE KEY UPDATE apiPlaceId = apiPlaceId;
                    INSERT INTO API_PLACE_TOUR (fk_tourDayId, fk_apiPlaceId, position) VALUES (@tourDayId, #{p.place.placeId}, #{pos});
                    SET @placeApiInsertedId = (SELECT LAST_INSERT_ID());
                    <foreach item="t" collection="p.transport">
                        INSERT INTO TRANSPORT_API_PLACE_TOUR (fk_placeApiTourId,fk_transportId) VALUES (@placeApiInsertedId, #{t.fk_transportId});
                    </foreach>
                </if>

            </foreach>
        </foreach>
    </insert>

</mapper>